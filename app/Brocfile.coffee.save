filterCoffeescript = require 'broccoli-coffee'
mergeTrees = require 'broccoli-merge-trees'
browserify = require 'broccoli-browserify'
pickFiles = require 'broccoli-static-compiler'
uglifyJS = require 'broccoli-uglify-js'
cleanCSS = require 'broccoli-clean-css'
concat = require 'broccoli-concat'
inlineAssets = require './utils/broccoli-inline-assets'

client = 'app/client'
counter = client + 'counter'

appScripts = pickFiles counter,
  srcDir: '/'
  destDir: '/'
  files: ['**/*.coffee', '**/*.js']

appScripts = filterCoffeescript appScripts

appScripts = browserify appScripts,
  entries: ['./counter']
  outputFile: 'counter.js'

appStyles = pickFiles counter,
  srcDir: '/'
  destDir: '/'
  files: ['**/*.css']

appStyles = concat appStyles,
  inputFiles: ['counter.css']
  outputFile: '/counter.css'

if process.env.NODE_ENV == 'production'
  appScripts = uglifyJS appScripts,
    mangle: true

  appStyles = cleanCSS appStyles

html = pickFiles counter,
  srcDir: '/'
  destDir: '/'
  files: ['**/*.html']

commonFiles = pickFiles client,
  srcDir: '/'
  destDir: '/common'
  files: ['favicon.ico']

counterAssets = mergeTrees [html, appScripts, appStyles]

counterAssets = inlineAssets counterAssets,
  files:
    'index.html': ['counter.js', 'counter.css']

counterAssets = pickFiles counterAssets,
  srcDir: '/'
  destDir: '/counter'
  files: 'index.html'

mergedAssets = mergeTrees [commonFiles, counterAssets]

module.exports = mergedAssets
